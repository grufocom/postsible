# playbooks/site.yml
---
- name: Postsible Mailserver - Complete Installation
  hosts: mailservers
  become: yes
  pre_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "==================================================="
          - "Postsible Mailserver Deployment"
          - "==================================================="
          - "Target Host: {{ inventory_hostname }}"
          - "Hostname: {{ common_hostname | default(ansible_hostname) }}"
          - "Primary Domain: {{ mail_primary_domain }}"
          - "Deployment Date: {{ ansible_date_time.iso8601 }}"
          - "==================================================="
      tags: always

    - name: Check if Debian 13
      assert:
        that:
          - ansible_distribution == "Debian"
          - ansible_distribution_major_version|int >= 13
        fail_msg: "This playbook requires Debian 13 or higher"
        success_msg: "Debian version check passed"
      tags: always

    - name: Gather package facts
      package_facts:
        manager: auto
      tags: always

  roles:
    # Phase 1: Basic-infrastructur
    - role: common
      tags:
        - common
        - phase1

    - role: ufw
      tags:
        - ufw
        - firewall
        - phase1

    - role: mariadb
      tags:
        - mariadb
        - database
        - phase1

    # Phase 2: Mail-Core
    - role: postfix
      tags:
        - postfix
        - mail
        - phase2

    - role: dovecot
      tags:
        - dovecot
        - mail
        - phase2

    # Phase 3: Spam & Antivirus
    - role: rspamd
      tags:
        - rspamd
        - spam
        - phase3

    - role: eset_icap
      tags:
        - eset
        - antivirus
        - phase3
      when: eset_icap_enabled | default(false)

    # Phase 4: Web & SSL
    - role: nginx
      tags:
        - nginx
        - web
        - phase4

    - role: certbot
      tags:
        - certbot
        - ssl
        - phase4

    - role: snappymail
      tags:
        - snappymail
        - webmail
        - phase4

    - role: baikal
      tags:
        - baikal
        - caldav
        - phase4

    - role: infcloud
      tags:
        - infcloud
        - phase4

    - role: autoconfig
      tags:
        - autoconfig
        - phase4

    # Phase 5: Security
    - role: fail2ban
      tags:
        - fail2ban
        - security
        - phase5

  post_tasks:
    - name: Ensure postsible directory exists
      file:
        path: /etc/postsible
        state: directory
        mode: '0755'
      tags: always

    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Restart all existing mail and web services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      loop:
        - mariadb
        - postfix
        - dovecot
        - nginx
        - fail2ban
        - php8.4-fpm
      when: item + '.service' in ansible_facts.services
      tags:
        - always

    - name: Check if admin user already exists
      shell: |
        mysql -u root -p'{{ mariadb_root_password }}' {{ mariadb_database }} -sN -e "SELECT COUNT(*) FROM virtual_users WHERE email='{{ mail_admin_email }}';"
      register: admin_user_exists
      changed_when: false
      tags: always

    - name: Create admin user with auto-generated password
      shell: |
        /usr/local/bin/maildb-manage add-user {{ mail_admin_email }} --auto-password --displayname "Administrator" --quiet
      register: admin_password_output
      when: admin_user_exists.stdout == "0"
      tags: always

    - name: Save admin password to file
      copy:
        content: |
          Postsible Admin User Credentials
          ================================
          Email: {{ mail_admin_email }}
          Password: {{ admin_password_output.stdout }}
          
          Created: {{ ansible_date_time.iso8601 }}
          
          IMPORTANT: Save this password securely and delete this file!
          
          Access:
          - Webmail: https://{{ snappymail_domain }}
          - CalDAV/CardDAV: https://{{ common_hostname }}/dav/
          - InfCloud: https://{{ common_hostname }}/cal/
        dest: /root/admin-credentials.txt
        mode: '0600'
      when: admin_user_exists.stdout == "0"
      tags: always

    - name: Extract username from admin email
      set_fact:
        mail_admin_username: "{{ mail_admin_email.split('@')[0] }}"
      tags:
        - welcome_email
        - always

    - name: Create welcome email template
      copy:
        content: |
          From: Postsible Mailserver <postmaster@{{ mail_primary_domain }}>
          To: {{ mail_admin_email }}
          Subject: Welcome to your Postsible Mailserver! üéâ
          Date: {{ ansible_date_time.iso8601 }}
          MIME-Version: 1.0
          Content-Type: text/plain; charset=UTF-8

          ========================================
          Welcome to your Postsible Mailserver!
          ========================================

          Dear Administrator,

          your mailserver has been successfully deployed and configured.

          üìç **Access Information**
          ------------------------
          Webmail:   https://{{ snappymail_domain }}/wm/
          Admin URL: https://{{ snappymail_domain }}/wm/?admin

          IMAP:      {{ common_hostname }}:993 (SSL/TLS)
          SMTP:      {{ common_hostname }}:587 (STARTTLS)

          üìÖ **Calendar Integration (CalDAV)**
          -------------------------
          To integrate your calendar into Thunderbird:

          1. Open Thunderbird
          2. Click on "Calendar" tab
          3. Right-click ‚Üí "New Calendar"
          4. Select "On the Network" ‚Üí "CalDAV"
          5. Enter your email: {{ mail_admin_email }}
          6. Enter this location:
             https://{{ mail_primary_domain }}/dav/dav.php/calendars/{{ mail_admin_email }}/default/
          7. Enter your email password

          üë• **Contacts Integration (CardDAV)**
          ---------------------------
          To integrate your contacts into Thunderbird:

          1. Install the "CardBook" addon (recommended) or use built-in CardDAV
          2. Add a new address book:
             - Type: CardDAV
             - Name: "My Contacts"
             - URL: https://{{ mail_primary_domain }}/dav/dav.php/addressbooks/{{ mail_admin_email }}/{{ mail_admin_username }}-contacts/
             - Username: {{ mail_admin_email }}
             - Password: (your email password)

          üì± **Mobile Setup (iOS/Android)**
          -------------------------
          iOS/macOS:
          - Settings ‚Üí Mail ‚Üí Accounts ‚Üí Add Account ‚Üí Other
          - Add CalDAV/CardDAV account with your credentials

          Android (using DAVx‚Åµ):
          - Install DAVx‚Åµ from F-Droid/Play Store
          - Add account with base URL: https://{{ mail_primary_domain }}/dav/dav.php/
          - Username: {{ mail_admin_email }}
          - Password: (your email password)

          üîß **Management Commands**
          -----------------
          Add user:         maildb-manage add-user user@example.com
          List users:       maildb-manage list-users
          Change password:  maildb-manage change-password user@example.com

          Check queue:      postfix-queue show
          Monitor:          postfix-monitor
          Firewall:         ufw-manage status
          Rspamd:           rspamd-stats.sh

          üìö **Documentation**
          -----------------
          All credentials are stored in:
          - /root/admin-credentials.txt
          - /etc/postsible/deployment_summary.txt

          Important files:
          - DKIM DNS records: /root/dkim-dns-records.txt
          - Database backups: /var/backups/mariadb/
          - Logs: /var/log/mail/

          ========================================
          Thank you for using Postsible!
          Your mailserver is ready to serve.
          ========================================
        dest: /tmp/welcome_email.txt
        mode: '0600'
      tags:
        - welcome_email
        - always

    - name: Send welcome email to admin
      shell: |
        sendmail {{ mail_admin_email }} < /tmp/welcome_email.txt
      args:
        executable: /bin/bash
      register: welcome_email_result
      changed_when: welcome_email_result.rc == 0
      failed_when: false  # Don't fail the whole playbook if email fails
      tags:
        - welcome_email
        - always

    - name: Display email status
      debug:
        msg:
          - "Welcome email sent to {{ mail_admin_email }}"
          - "Calendar URL: https://{{ mail_primary_domain }}/dav/dav.php/calendars/{{ mail_admin_email }}/default/"
          - "Contacts URL: https://{{ mail_primary_domain }}/dav/dav.php/addressbooks/{{ mail_admin_email }}/{{ mail_admin_username }}-contacts/"
      when: welcome_email_result.rc == 0
      tags:
        - welcome_email
        - always

    - name: Display warning if email failed
      debug:
        msg:
          - "‚ö†Ô∏è  Could not send welcome email to {{ mail_admin_email }}"
          - "The email content is saved at: /tmp/welcome_email.txt"
          - "You can send it manually with:"
          - "  sendmail {{ mail_admin_email }} < /tmp/welcome_email.txt"
      when: welcome_email_result.rc != 0
      tags:
        - welcome_email
        - always

    - name: Display admin user information
      debug:
        msg:
          - "==================================================="
          - "Admin User Created!"
          - "==================================================="
          - "Email: {{ mail_admin_email }}"
          - "Password: {{ admin_password_output.stdout }}"
          - ""
          - "Credentials saved to: /root/admin-credentials.txt"
          - "Please save the password securely and delete the file!"
          - "==================================================="
      when: admin_user_exists.stdout == "0"
      tags: always

    - name: Display completion information
      debug:
        msg:
          - "==================================================="
          - "Postsible Mailserver Deployment Complete!"
          - "==================================================="
          - "Webmail: https://{{ snappymail_domain }}"
          - "Rspamd WebUI: https://{{ common_hostname }}/rspamd"
          - "CalDAV/CardDAV: https://{{ common_hostname }}/dav/"
          - "InfCloud: https://{{ common_hostname }}/cal/"
          - "IMAP: {{ common_hostname }}:993 (SSL/TLS)"
          - "SMTP Submission: {{ common_hostname }}:587 (STARTTLS)"
          - "==================================================="
          - "Next Steps:"
          - "1. Configure DNS records (MX, SPF, DKIM, DMARC)"
          - "2. Save admin password from /root/admin-credentials.txt"
          - "3. Test email sending/receiving"
          - "4. Configure backup strategy"
          - "==================================================="
      tags: always

    - name: Create deployment summary file
      copy:
        content: |
          Postsible Mailserver Deployment Summary
          ========================================
          Deployment Date: {{ ansible_date_time.iso8601 }}
          Hostname: {{ common_hostname }}
          Primary Domain: {{ mail_primary_domain }}
          Admin Email: {{ mail_admin_email }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          Services Installed:
          - Postfix (SMTP)
          - Dovecot (IMAP/LMTP/Sieve)
          - Rspamd (Spam Filter)
          - SnappyMail (Webmail)
          - Baikal (CalDAV/CardDAV)
          - InfCloud (Web Calendar/Contacts)
          - Nginx (Web Server)
          - MariaDB (Database)
          - Certbot (Let's Encrypt)
          - UFW (Firewall)
          - Fail2ban (Intrusion Prevention)
          {% if eset_icap_enabled %}
          - ESET ICAP (Antivirus)
          {% endif %}
          
          Access Points:
          - Webmail: https://{{ snappymail_domain }}
          - Rspamd WebUI: https://{{ common_hostname }}/rspamd
          - CalDAV/CardDAV: https://{{ common_hostname }}/dav/
          - InfCloud: https://{{ common_hostname }}/cal/
          - IMAP: {{ common_hostname }}:993
          - SMTP: {{ common_hostname }}:587
          
          Database:
          - Name: {{ mariadb_database }}
          - User: {{ mariadb_user }}
          - Host: {{ mariadb_host }}
          
          Important Files:
          - Maildir: /srv/imap/
          - Logs: /var/log/mail/
          - Config: /etc/postsible/
          - Admin Credentials: /root/admin-credentials.txt (DELETE AFTER SAVING!)
          
          User Management:
          - Add user: maildb-manage add-user user@example.com
          - Add user (auto-password): maildb-manage add-user user@example.com --auto-password
          - List users: maildb-manage list-users
          - Change password: maildb-manage change-password user@example.com
          - Help: maildb-manage help
        dest: /etc/postsible/deployment_summary.txt
        mode: '0644'
      tags: always
