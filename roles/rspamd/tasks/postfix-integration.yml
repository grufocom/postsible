---
# roles/rspamd/tasks/postfix-integration.yml

- name: Check if Postfix is installed
  stat:
    path: /etc/postfix/main.cf
  register: postfix_installed

- name: Verify rspamd milter is listening
  wait_for:
    host: 127.0.0.1
    port: 11332
    timeout: 10
  when: postfix_installed.stat.exists

- name: Check if Postfix milter configuration exists
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: '^smtpd_milters.*127\.0\.0\.1:11332'
    state: absent
  check_mode: yes
  register: milter_configured
  changed_when: false
  when: postfix_installed.stat.exists

- name: Print Postfix integration status
  debug:
    msg: |
      ========================================
      Postfix-Rspamd Integration
      ========================================
      
      {% if postfix_installed.stat.exists %}
      Postfix: INSTALLED
      
      {% if milter_configured is defined and not milter_configured.changed %}
      Milter Config: CONFIGURED âœ“
      Rspamd is integrated with Postfix.
      {% else %}
      Milter Config: NOT CONFIGURED
      
      To enable rspamd integration, ensure these variables are set in Postfix role:
        postfix_smtpd_milters: "inet:127.0.0.1:11332"
        postfix_non_smtpd_milters: "inet:127.0.0.1:11332"
        postfix_milter_default_action: "accept"
        postfix_milter_protocol: "6"
      
      Then re-run the Postfix role:
        ansible-playbook playbooks/site.yml --tags postfix
      {% endif %}
      
      {% else %}
      Postfix: NOT INSTALLED YET
      Postfix will be configured to use rspamd when installed.
      {% endif %}
      
      Rspamd milter is listening on: 127.0.0.1:11332
      
      Test with:
        telnet 127.0.0.1 11332
      
      ========================================
  when: postfix_installed.stat.exists or not postfix_installed.stat.exists
