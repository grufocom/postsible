#!/bin/bash
# {{ ansible_managed }}
# Postfix queue management

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << HELP
Postfix Queue Management Tool

Usage: $(basename $0) [COMMAND]

Commands:
  show            Show mail queue
  count           Count messages in queue
  flush           Flush mail queue (force delivery)
  delete-all      Delete all messages in queue (DANGEROUS!)
  delete ID       Delete specific message by ID
  hold ID         Put message on hold
  release ID      Release held message
  requeue-all     Requeue all deferred messages
  show-hold       Show messages on hold
  show-deferred   Show deferred messages
  help            Show this help message

Examples:
  postfix-queue show
  postfix-queue delete ABC123
  postfix-queue flush
HELP
}

show_queue() {
    echo -e "${BLUE}=== Mail Queue ===${NC}"
    mailq
}

count_queue() {
    local count=$(mailq | grep -c "^[A-F0-9]" || echo "0")
    echo -e "${BLUE}Messages in queue: ${NC}$count"
}

flush_queue() {
    echo -e "${YELLOW}Flushing mail queue...${NC}"
    postqueue -f
    echo -e "${GREEN}Queue flushed${NC}"
}

delete_all() {
    echo -e "${RED}WARNING: This will delete ALL messages in the queue!${NC}"
    echo -e "${YELLOW}Are you sure? (yes/no):${NC}"
    read -r confirm
    if [[ "$confirm" != "yes" ]]; then
        echo "Cancelled."
        exit 0
    fi
    
    echo -e "${YELLOW}Deleting all messages...${NC}"
    postsuper -d ALL
    echo -e "${GREEN}All messages deleted${NC}"
}

delete_message() {
    local id=$1
    if [[ -z "$id" ]]; then
        echo -e "${RED}Error: Message ID required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Deleting message $id...${NC}"
    postsuper -d "$id"
    echo -e "${GREEN}Message deleted${NC}"
}

hold_message() {
    local id=$1
    if [[ -z "$id" ]]; then
        echo -e "${RED}Error: Message ID required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Holding message $id...${NC}"
    postsuper -h "$id"
    echo -e "${GREEN}Message on hold${NC}"
}

release_message() {
    local id=$1
    if [[ -z "$id" ]]; then
        echo -e "${RED}Error: Message ID required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Releasing message $id...${NC}"
    postsuper -H "$id"
    echo -e "${GREEN}Message released${NC}"
}

requeue_all() {
    echo -e "${YELLOW}Requeuing all deferred messages...${NC}"
    postsuper -r ALL
    echo -e "${GREEN}Messages requeued${NC}"
}

show_hold() {
    echo -e "${BLUE}=== Messages on Hold ===${NC}"
    mailq | grep "^[A-F0-9].*HOLD" || echo "No messages on hold"
}

show_deferred() {
    echo -e "${BLUE}=== Deferred Messages ===${NC}"
    mailq | grep "^[A-F0-9]" | grep -v "HOLD" || echo "No deferred messages"
}

case "${1:-}" in
    show)
        show_queue
        ;;
    count)
        count_queue
        ;;
    flush)
        flush_queue
        ;;
    delete-all)
        delete_all
        ;;
    delete)
        delete_message "$2"
        ;;
    hold)
        hold_message "$2"
        ;;
    release)
        release_message "$2"
        ;;
    requeue-all)
        requeue_all
        ;;
    show-hold)
        show_hold
        ;;
    show-deferred)
        show_deferred
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac
