#!/bin/bash
# {{ ansible_managed }}
# Backup script for Postsible mailserver database

set -e

BACKUP_DIR="/var/backups/mariadb"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/{{ mariadb_database }}_$TIMESTAMP.sql.gz"
RETENTION_DAYS={{ mariadb_backup_retention_days }}

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

echo "Starting backup of {{ mariadb_database }} database..."

# Dump database
mysqldump \
  -u root \
  -p'{{ mariadb_root_password }}' \
  --single-transaction \
  --quick \
  --lock-tables=false \
  {{ mariadb_database }} | gzip > "$BACKUP_FILE"

# Set permissions
chmod 600 "$BACKUP_FILE"

# Get file size
SIZE=$(du -h "$BACKUP_FILE" | cut -f1)

echo "Backup completed: $BACKUP_FILE ($SIZE)"

# Clean old backups
echo "Cleaning backups older than $RETENTION_DAYS days..."
find "$BACKUP_DIR" -name "{{ mariadb_database }}_*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete

# Count remaining backups
BACKUP_COUNT=$(find "$BACKUP_DIR" -name "{{ mariadb_database }}_*.sql.gz" -type f | wc -l)
echo "Total backups retained: $BACKUP_COUNT"

# Log to syslog
logger -t maildb-backup "Database backup completed: $BACKUP_FILE ($SIZE)"

exit 0
