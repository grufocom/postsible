#!/bin/bash
# {{ ansible_managed }}
# UFW Backup Script

set -e

BACKUP_DIR="/var/backups/ufw"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/ufw_rules_$TIMESTAMP.txt"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Backup UFW rules
echo "Backing up UFW rules to $BACKUP_FILE"
ufw status numbered > "$BACKUP_FILE"

# Also backup raw iptables rules
iptables-save > "$BACKUP_DIR/iptables_$TIMESTAMP.rules"
ip6tables-save > "$BACKUP_DIR/ip6tables_$TIMESTAMP.rules"

# Backup UFW config files
tar -czf "$BACKUP_DIR/ufw_config_$TIMESTAMP.tar.gz" /etc/ufw/

echo "Backup completed:"
echo "  Rules: $BACKUP_FILE"
echo "  iptables: $BACKUP_DIR/iptables_$TIMESTAMP.rules"
echo "  Config: $BACKUP_DIR/ufw_config_$TIMESTAMP.tar.gz"

# Keep only last 30 backups
find "$BACKUP_DIR" -name "ufw_rules_*.txt" -type f -mtime +30 -delete
find "$BACKUP_DIR" -name "iptables_*.rules" -type f -mtime +30 -delete
find "$BACKUP_DIR" -name "ip6tables_*.rules" -type f -mtime +30 -delete
find "$BACKUP_DIR" -name "ufw_config_*.tar.gz" -type f -mtime +30 -delete

echo "Old backups cleaned up (kept last 30 days)"

