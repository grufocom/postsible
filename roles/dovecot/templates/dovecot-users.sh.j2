#!/bin/bash
# {{ ansible_managed }}
# Dovecot user management script

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << HELP
Dovecot User Management Tool

Usage: $(basename $0) [COMMAND] [OPTIONS]

Commands:
  list                List all users and their connection status
  who                 Show currently connected users
  kick USER           Disconnect all sessions for a user
  mailbox USER        Show mailboxes for a user
  quota USER          Show quota for a user
  passwd USER         Change password for a user (via maildb-manage)
  stats               Show connection statistics
  help                Show this help message

Note: Auth testing disabled due to Debian Dovecot 2.4.1 bug.
      Test login via IMAP directly: telnet localhost 143

Examples:
  dovecot-users list
  dovecot-users who
  dovecot-users kick admin@example.com
  dovecot-users mailbox admin@example.com
  dovecot-users quota admin@example.com
HELP
}

list_users() {
    echo -e "${BLUE}=== Dovecot Users ===${NC}"
    doveadm user '*' 2>/dev/null || echo "Error listing users"
}

show_who() {
    echo -e "${BLUE}=== Currently Connected Users ===${NC}"
    doveadm who 2>/dev/null || echo "No active connections"
}

kick_user() {
    local user=$1
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: User required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Disconnecting all sessions for $user...${NC}"
    doveadm kick "$user" 2>/dev/null
    echo -e "${GREEN}Done${NC}"
}

show_mailbox() {
    local user=$1
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: User required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}=== Mailboxes for $user ===${NC}"
    doveadm mailbox list -u "$user" 2>/dev/null
}

show_quota() {
    local user=$1
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: User required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}=== Quota for $user ===${NC}"
    doveadm quota get -u "$user" 2>/dev/null || echo "Quota not configured"
}

change_passwd() {
    local user=$1
    if [[ -z "$user" ]]; then
        echo -e "${RED}Error: User required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Use maildb-manage to change password:${NC}"
    echo "  maildb-manage change-password $user"
}

show_stats() {
    echo -e "${BLUE}=== Connection Statistics ===${NC}"
    
    total=$(doveadm who 2>/dev/null | wc -l)
    echo "Total active connections: $total"
    
    echo ""
    echo "By protocol:"
    doveadm who 2>/dev/null | awk '{print $4}' | sort | uniq -c | sort -rn
    
    echo ""
    echo "Top 10 users:"
    doveadm who 2>/dev/null | awk '{print $1}' | sort | uniq -c | sort -rn | head -10
    
    echo ""
    echo "Process count:"
    ps aux | grep -c "dovecot/imap" | xargs echo "IMAP processes:"
    ps aux | grep -c "dovecot/pop3" | xargs echo "POP3 processes:"
}

case "${1:-}" in
    list)
        list_users
        ;;
    who)
        show_who
        ;;
    kick)
        kick_user "$2"
        ;;
    mailbox)
        show_mailbox "$2"
        ;;
    quota)
        show_quota "$2"
        ;;
    passwd)
        change_passwd "$2"
        ;;
    stats)
        show_stats
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac
