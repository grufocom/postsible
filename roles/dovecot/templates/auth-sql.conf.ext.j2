# {{ ansible_managed }}
# SQL authentication (Dovecot 2.4.1)

passdb sql {
  query = SELECT password FROM virtual_users WHERE email='%{user}' AND enabled=1
}

userdb sql {
  query = SELECT \
    'vmail' AS uid, \
    'vmail' AS gid, \
    CONCAT('/srv/imap/', SUBSTRING_INDEX(email, '@', -1), '/', SUBSTRING_INDEX(email, '@', 1)) AS home, \
    CONCAT('maildir:/srv/imap/', SUBSTRING_INDEX(email, '@', -1), '/', SUBSTRING_INDEX(email, '@', 1)) AS mail \
  FROM virtual_users WHERE email='%{user}' AND enabled=1 LIMIT 1
}

