---
# Nginx configuration for Baïkal

- name: Remove any existing Baïkal blocks (cleanup)
  shell: |
    sed -i '/# BEGIN ANSIBLE MANAGED BLOCK - Baïkal/,/# END ANSIBLE MANAGED BLOCK - Baïkal/d' /etc/nginx/sites-available/rspamd
    sed -i '/# BEGIN ANSIBLE MANAGED - Baïkal/,/# END ANSIBLE MANAGED - Baïkal/d' /etc/nginx/sites-available/rspamd
    sed -i '/# BEGIN ANSIBLE MANAGED BLOCK - Baïkal Well-Known/,/# END ANSIBLE MANAGED BLOCK - Baïkal Well-Known/d' /etc/nginx/sites-available/rspamd
  register: cleanup_result
  changed_when: false
  failed_when: false
  tags: baikal

- name: Add Baïkal location to main VHost (inside HTTPS server block)
  blockinfile:
    path: /etc/nginx/sites-available/rspamd
    marker: "    # {mark} ANSIBLE MANAGED BLOCK - Baïkal"
    insertbefore: "^\\s*# Deny access to hidden files"
    block: |2
          # CalDAV/CardDAV Discovery (RFC 6764) - MUST be before hidden files deny
          location ^~ /.well-known/carddav {
              return 301 $scheme://$host{{ baikal_url_path }}/dav.php;
          }
          
          location ^~ /.well-known/caldav {
              return 301 $scheme://$host{{ baikal_url_path }}/dav.php;
          }

          # Baïkal CalDAV/CardDAV Server - Deny Specific directory first
          location ~ ^{{ baikal_url_path }}/Specific {
              deny all;
          }

          # Baïkal PHP files
          location ~ ^{{ baikal_url_path }}/(.+\.php)(/.*)?$ {
              alias {{ baikal_install_path }}/html/$1;
              
              fastcgi_split_path_info ^(.+\.php)(/?.+)$;
              fastcgi_pass unix:{{ nginx_php_fpm_socket }};
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $request_filename;
              fastcgi_param PATH_INFO $fastcgi_path_info;
              fastcgi_param REQUEST_METHOD $request_method;
              include fastcgi_params;
          }

          # Baïkal static files and directory
          location {{ baikal_url_path }}/ {
              alias {{ baikal_install_path }}/html/;
              index dav.php index.php;
              
              try_files $uri $uri/ =404;
          }
  notify: reload nginx
  tags: baikal

- name: Test Nginx configuration
  command: nginx -t
  changed_when: false
  register: nginx_test
  failed_when: nginx_test.rc != 0
  tags: baikal

- name: Display Nginx test result
  debug:
    var: nginx_test.stderr_lines
  when: nginx_test.rc != 0
  tags: baikal

- name: Reload Nginx
  systemd:
    name: nginx
    state: reloaded
  when: nginx_test.rc == 0
  tags: baikal
